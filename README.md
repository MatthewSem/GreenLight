# GreenLight Support & Onboarding Bot

Telegram-бот для поддержки и онбординга клиентов GreenLight Partners.

## Требования

- Python 3.11+
- PostgreSQL

## Установка

```bash
python -m venv venv
venv\Scripts\activate   # Windows
# source venv/bin/activate  # Linux/Mac

pip install -r requirements.txt
```

## Настройка

1. Скопируйте `.env.example` в `.env`
2. Заполните:
   - `BOT_TOKEN` — токен от @BotFather
   - `SUPPORT_GROUP_ID` — ID группы операторов (с минусом, например -1001234567890)
   - `ADMIN_CHAT_ID` — ID чата администраторов
   - `DATABASE_URL` — строка подключения к PostgreSQL
   - `ADMIN_IDS` — tg_id админов через запятую (для первоначального доступа)

3. Создайте БД:
   ```sql
   CREATE DATABASE greenlight;
   ```

4. Добавьте бота в Support Group и Admin Chat как администратора (с правом «Управление темами» в группе)

5. **Важно:** В группе поддержки включите **Темы** (Forum): настройки группы → Темы → Включить. Тогда при нажатии «Взять» тикет переносится в отдельную тему.

### Как устроена переписка

- **Клиент** общается только с ботом (личный чат): пишет сообщения боту и получает ответы там же. Для него это обычный диалог с ботом.
- **Операторы** работают только в своём чате (группа поддержки): видят тикеты, нажимают «Ответить», пишут ответ в чат/тему — это сообщение **отправляется клиенту в бота**. Новый чат создавать не нужно: клиент получает ответ в том же личном чате с ботом, переписка выглядит непрерывной.

Итого: все сообщения клиента приходят в чат поддержки; все ответы оператора уходят клиенту в бота. Один поток переписки у клиента, один у саппорта.

- **Закрытый тикет (CLOSED):** нельзя отвечать клиенту и эскалировать; доступны только «История» и «Статус» (можно снова открыть, если закрыли по ошибке).
- **Взятый тикет:** действовать (ответить, эскалация, смена статуса, история) может только тот оператор, который нажал «Взять». Остальные видят сообщение «Тикет ведёт другой оператор».

## Запуск

```bash
python bot.py
```

## Добавление операторов

Админ в личку боту:
```
/set_role 123456789 support
```

## CRM: Google Sheets

1. Создайте проект в Google Cloud Console, включите Google Sheets API.
2. Создайте сервисный аккаунт и скачайте JSON-ключ. Положите файл в проект (например `credentials.json`).
3. Создайте Google-таблицу, откройте доступ на редактирование для email сервисного аккаунта (из JSON).
4. В листе создайте строку заголовков (первая строка): `lead_id`, `tg_id`, `username`, `created_at`, `status`, `answer_1` … `answer_9`.
5. В `.env` укажите:
   - `GOOGLE_SHEETS_ENABLED=true`
   - `GOOGLE_CREDENTIALS_FILE=credentials.json`
   - `SPREADSHEET_ID=` (ID из URL таблицы)
   - `SHEET_NAME=Лиды` (имя листа)

## Команды бота (при вводе /)

- **/start** — начать диалог с поддержкой
- **/help** — список команд; для админа — полный список с описанием
- **/broadcast** — [Админ] массовая рассылка
- **/set_role** — [Админ] назначить роль: `/set_role <tg_id> client|support|admin`
- **/cancel** — [Админ] отменить рассылку

Админ при вводе `/help` видит все команды с подробным описанием.

## Структура проекта

```
GreenLight/
├── bot.py           # Точка входа
├── config.py        # Конфигурация
├── database.py      # Подключение к PostgreSQL
├── constants.py     # Константы, тексты
├── keyboards.py     # Клавиатуры
├── handlers/        # Обработчики
│   ├── client.py    # Клиенты: /start, онбординг, тикеты
│   ├── support.py   # Support Group: кнопки тикетов
│   └── admin.py     # Broadcast, set_role
└── services/        # Бизнес-логика
    ├── db.py        # Операции с БД
    ├── crm.py       # Отправка в CRM
    ├── support_chat.py  # Сообщения в Support/Admin чаты
    └── working_hours.py # Рабочее время
```
